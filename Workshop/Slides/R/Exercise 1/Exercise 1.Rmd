---
title: 'Exercise 1: Decomposing the crude death rate'
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

Let the function $v(x,y)$ be equivalent to the force of mortality $\mu(a,t)$ at age $a$ and time $t$ and let the weighting function be the age-specific population size. Then it follows directly from equation (4) that 
\begin{equation}
\dot{\bar{\mu}} = \bar{\dot{\mu}} +Cov(\mu,r)
\end{equation}

where $\bar{\mu}(t)$ is the crude death rate (CDR) of the population.

The file 'Data_Exercise_RData' contains mortality and exposure data for Danish females from 1991 to 1997. The exercise consists in decomposing the cganges in CDR following Vaupel \& Canudas-Romo (2002) or equation (1)

You'll need the package 'data.table' to follow this handout. Start by loading the data.


```{r,message=FALSE, warning=FALSE}
library(data.table)
load('Data_Exercise_1.RData')
```

To compute the CDR we need age-specific mortality and the population structure to calculate the weighted average.

```{r,message=FALSE, warning=FALSE}
#get the age-specific mortality rates
Denmark.data$mx <- Denmark.data$Deaths/Denmark.data$Exposures

#get the population structure
Denmark.data <- Denmark.data[,Nx := Exposures/sum(Exposures), by = list(Year)]

head(Denmark.data)

#get CDR by year
CDR <- Denmark.data[,list(CDR = sum(mx*Nx, na.rm = T)*1000), by = list(Year)]
CDR
```

Now we need an approximation from continuous to descrete of the derivative od the CDR:

```{r,message=FALSE, warning=FALSE}
# mean change from 1991 to 1997 centered in 1994
mu.bar.dot <- mean(diff(CDR$CDR))
mu.bar.dot
```

To get $\bar{\dot{\mu}}$ we need an approximation for the age-pecific mortality change over time and the population structure to compute the weighted average:

```{r,message=FALSE, warning=FALSE}
# get change of age specific mortality over time
mu.dot.x <- Denmark.data[, list(mu.dot = mean(diff(mx,na.rm = T),na.rm = T)), by = list(Age)]

# population structure of 1994
structure.1994 <- Denmark.data[Denmark.data$Year==1994,]$Nx

# get the average applying the structure of 1994
# This is the direct effect
direct.effect <- sum(mu.dot.x$mu.dot*structure.1994)*1000
direct.effect
```

Now we need to calculate the $Cov(\mu,r)$. We wil use the formula:

\begin{equation}
Cov(w,\acute{w}) = E(v\acute{w})-E(v)E(\acute{w})
\end{equation}

First, we need $r$, the growth rate, as the relative derivative of the population structure. Then we need the change in age specific mortality and apply to both the weights.

```{r,message=FALSE, warning=FALSE}
#get the poulation growth rate
r <- Denmark.data[,list(r = mean(unlist(lapply(1:(length(Nx)-1),function(x){
  y <- log(Nx[x+1]/Nx[x])
  y
})))), by = list(Age)]

#get the change of age specific mortality rates
mean.mu.x <- Denmark.data[, list(mu.x = mean(mx,na.rm = T)), by = list(Age)]

#get the weighted average
mean.r.mu <- sum(mean.mu.x$mu.x*r$r*structure.1994, na.rm = T)*1000

#get the weighted average growth rate
mean.r    <- sum(r$r*structure.1994,na.rm = T)

#get the weighted average mortality rate
mean.mu   <- sum(mean.mu.x$mu.x*structure.1994 ,na.rm = T)
```

Finally, we calculate the covariance, or compositional effect, as in equation (2) and compare the decomposition result with the approximation of the change in the CDR.

```{r,message=FALSE, warning=FALSE}
#get the covariance (compositional effect)
Compositional.effect <- mean.r.mu - mean.r*mean.mu*1000

#get total from decomposition
direct.effect + Compositional.effect

#original approximation
mu.bar.dot
```